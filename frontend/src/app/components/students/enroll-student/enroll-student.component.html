<div class="page-container">
  <div class="page-header">
    <h1>
      <span class="icon">ğŸ“</span>
      Enroll Student
    </h1>
    <p class="subtitle">List of registered students not yet allocated to classes</p>
  </div>

  <div class="actions">
    <a class="btn btn-secondary" routerLink="/students/new">
      â† Back to Registration
    </a>
    <button class="btn btn-primary" (click)="previewPdf()">ğŸ‘ï¸ Preview</button>
    <button class="btn btn-primary" (click)="printList()">ğŸ–¨ï¸ Print</button>
    <button class="btn btn-primary" (click)="exportCsv()">â¬‡ Export CSV</button>
  </div>

  <!-- Stats -->
  <div class="stats-grid" *ngIf="!loading">
    <div class="stat-card">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Unenrolled Students</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.male }}</div>
      <div class="stat-label">Male</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.female }}</div>
      <div class="stat-label">Female</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.dayScholar }}</div>
      <div class="stat-label">Day Scholars</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.boarder }}</div>
      <div class="stat-label">Boarders</div>
    </div>
    <div class="stat-card stat-wide" *ngIf="stats.byGrade.length">
      <div class="stat-title">Top Grades</div>
      <div class="bars">
        <div class="bar-row" *ngFor="let g of stats.byGrade">
          <div class="bar-label">{{ g.label }}</div>
          <div class="bar-track">
            <div class="bar-fill" [style.width.%]="(g.count / (stats.byGrade[0]?.count || 1)) * 100"></div>
          </div>
          <div class="bar-value">{{ g.count }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-item">
      <label>Grade</label>
      <select class="form-control" [(ngModel)]="selectedGrade" (change)="applyFilters()">
        <option value="">All</option>
        <option *ngFor="let g of gradeOptions" [value]="g">{{ g }}</option>
      </select>
    </div>
    <div class="filter-item">
      <label>Student Type</label>
      <select class="form-control" [(ngModel)]="selectedType" (change)="applyFilters()">
        <option value="">All</option>
        <option value="Day Scholar">Day Scholar</option>
        <option value="Boarder">Boarder</option>
      </select>
    </div>
    <div class="filter-actions">
      <button class="btn btn-secondary" (click)="clearFilters()">Clear Filters</button>
    </div>
  </div>

  <div class="search-section">
    <div class="search-input-wrapper">
      <span class="search-icon">ğŸ”</span>
      <input 
        type="text" 
        [(ngModel)]="searchQuery"
        (input)="filter()"
        placeholder="Search by Student ID, First Name, Last Name, or Phone Number"
        class="form-control search-input">
      <button *ngIf="searchQuery" class="clear-search" (click)="searchQuery=''; filter()">Ã—</button>
    </div>
  </div>

  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading students...</p>
  </div>

  <div *ngIf="!loading && filtered.length === 0" class="empty-state">
    <div class="empty-icon">âœ…</div>
    <h2>No Unenrolled Students</h2>
    <p>All registered students are allocated to classes.</p>
  </div>

  <div id="print-area">
    <h2 style="margin: 16px 0;">Registered Students Without Classes</h2>
    <table class="modern-table" *ngIf="!loading && filtered.length > 0">
      <thead>
        <tr>
          <th>Student Number</th>
          <th>First Name</th>
          <th>Last Name</th>
          <th>Gender</th>
          <th>Phone</th>
          <th>Grade</th>
          <th *ngIf="canEnroll()">Assign Class</th>
          <th *ngIf="canEnroll()">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of filtered">
          <td>{{ s.studentNumber || 'â€”' }}</td>
          <td>{{ s.firstName || 'â€”' }}</td>
          <td>{{ s.lastName || 'â€”' }}</td>
          <td>{{ s.gender || 'â€”' }}</td>
          <td>{{ s.phoneNumber || 'â€”' }}</td>
          <td>{{ s.grade || s.classLevel || 'â€”' }}</td>
          <td *ngIf="canEnroll()">
            <select class="form-control" [(ngModel)]="s._selectedClassId">
              <option value="">Select class</option>
              <option *ngFor="let c of classes" [value]="c.id">{{ c.name }}</option>
            </select>
          </td>
          <td *ngIf="canEnroll()">
            <button 
              class="btn btn-primary"
              [disabled]="!s._selectedClassId || enrollingMap[s.id || s.studentId]"
              (click)="enroll(s, s._selectedClassId)">
              <span *ngIf="!enrollingMap[s.id || s.studentId]">Enroll</span>
              <span *ngIf="enrollingMap[s.id || s.studentId]" class="spinner"></span>
            </button>
            <button 
              class="btn btn-primary"
              style="margin-left:8px"
              *ngIf="isAdmin()"
              [disabled]="deletingMap[s.id || s.studentId]"
              (click)="deleteStudentRecord(s)">
              <span *ngIf="!deletingMap[s.id || s.studentId]">Delete</span>
              <span *ngIf="deletingMap[s.id || s.studentId]" class="spinner"></span>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
