<div class="record-book-container">
  <div class="page-header">
    <div class="header-content">
      <div>
        <h1>ğŸ“š My Record Book</h1>
        <p>Manage and track student test marks</p>
      </div>
      <div class="header-actions" *ngIf="selectedClass && students.length > 0">
        <button class="btn btn-outline" (click)="previewRecordBookPDF()" title="Preview Record Book as PDF">
          ğŸ“„ Preview
        </button>
        <button class="btn btn-outline" (click)="exportToExcel()" title="Export to Excel">
          ğŸ“Š Export
        </button>
      </div>
    </div>
  </div>

  <!-- Error/Success Messages -->
  <div *ngIf="error" class="alert alert-error">
    <span class="alert-icon">âš ï¸</span>
    <span>{{ error }}</span>
    <button class="alert-close" (click)="error = ''">&times;</button>
  </div>
  
  <div *ngIf="success" class="alert alert-success">
    <span class="alert-icon">âœ“</span>
    <span>{{ success }}</span>
    <button class="alert-close" (click)="success = ''">&times;</button>
  </div>

  <!-- Class Selection -->
  <div class="card class-selector-card">
    <div class="card-header">
      <h3>ğŸ“‹ Select Class</h3>
      <span class="class-count" *ngIf="teacherClasses.length > 0">
        <span *ngIf="isUniversalTeacher">All {{ teacherClasses.length }} class{{ teacherClasses.length !== 1 ? 'es' : '' }}</span>
        <span *ngIf="!isUniversalTeacher">{{ teacherClasses.length }} class{{ teacherClasses.length !== 1 ? 'es' : '' }} assigned</span>
      </span>
    </div>
    <div class="class-subject-container">
      <div class="form-group">
        <label>{{ isUniversalTeacher ? 'All Classes' : 'Your Classes' }}</label>
        <div class="select-wrapper">
          <select [(ngModel)]="selectedClassId" (change)="onClassChange()" class="form-control modern-select">
            <option value="">-- Select a class --</option>
            <option *ngFor="let class of teacherClasses" [value]="class.id">
              {{ class.name }}
            </option>
          </select>
          <span class="select-arrow">â–¼</span>
        </div>
      </div>
      <div class="form-group" *ngIf="selectedClassId && availableSubjects.length > 0">
        <label>Select Subject <span class="required">*</span></label>
        <div class="select-wrapper">
          <select [(ngModel)]="selectedSubjectId" (change)="onSubjectChange()" class="form-control modern-select">
            <option value="">-- Select a subject --</option>
            <option *ngFor="let subject of availableSubjects" [value]="subject.id">
              {{ subject.name }}
            </option>
          </select>
          <span class="select-arrow">â–¼</span>
        </div>
      </div>
      <div class="form-group form-group-subject">
        <label>Subject(s) Teaching</label>
        <textarea 
          [(ngModel)]="teacherSubjects" 
          class="subject-textarea" 
          readonly
          placeholder="Select a class to view subject(s)..."
          rows="1"></textarea>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading record book...</p>
  </div>

  <!-- Record Book Table -->
  <div *ngIf="!loading && selectedClass && selectedSubject && students.length > 0" class="record-book-content">
    <!-- Search and Filter -->
    <div class="toolbar">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="filterStudents()"
          placeholder="Search students by name or ID..."
          class="search-input">
        <button *ngIf="searchTerm" class="clear-search" (click)="clearSearch()">&times;</button>
      </div>
      
      <div class="column-controls">
        <button 
          class="btn btn-icon" 
          (click)="addTestColumn()" 
          [disabled]="visibleTests >= maxTests"
          title="Add Test Column">
          â•
        </button>
        <span class="column-info">{{ visibleTests }}/{{ maxTests }} tests</span>
        <button 
          class="btn btn-icon" 
          (click)="removeTestColumn()" 
          [disabled]="visibleTests <= 1"
          title="Remove Test Column">
          â–
        </button>
      </div>
    </div>

    <!-- Students Table -->
    <div class="table-wrapper">
      <table class="record-table modern-table">
        <thead>
          <tr>
            <th class="sticky-col">#</th>
            <th class="sticky-col">Student ID</th>
            <th>LastName</th>
            <th>FirstName</th>
            <th *ngFor="let testNum of getVisibleTestNumbers()" class="test-header">
              <div class="test-header-content">
                <span>Test {{ testNum }}</span>
                <span class="test-max">/100</span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let student of filteredStudents; let i = index" 
              [class.even-row]="i % 2 === 0"
              [class.odd-row]="i % 2 !== 0">
            <td class="sticky-col row-number">{{ i + 1 }}</td>
            <td class="sticky-col student-id">{{ student.studentNumber }}</td>
            <td class="student-name">{{ student.lastName }}</td>
            <td class="student-name">{{ student.firstName }}</td>
            <td *ngFor="let testNum of getVisibleTestNumbers()" class="mark-cell">
              <div class="mark-input-wrapper">
                <input 
                  type="number" 
                  [(ngModel)]="student['test' + testNum]" 
                  (blur)="onMarkChange(student, testNum)"
                  (focus)="onMarkFocus($event)"
                  min="0" 
                  max="100" 
                  step="1"
                  class="mark-input"
                  [class.has-value]="student['test' + testNum] !== null && student['test' + testNum] !== ''"
                  [class.excellent]="student['test' + testNum] >= 80"
                  [class.good]="student['test' + testNum] >= 60 && student['test' + testNum] < 80"
                  [class.average]="student['test' + testNum] >= 40 && student['test' + testNum] < 60"
                  [class.poor]="student['test' + testNum] < 40 && student['test' + testNum] !== null"
                  placeholder="â€”">
                <span class="mark-indicator" *ngIf="student['test' + testNum] !== null && student['test' + testNum] !== ''">
                  {{ getGradeIcon(student['test' + testNum]) }}
                </span>
              </div>
            </td>
          </tr>
          <!-- Topic Row -->
          <tr class="topic-row">
            <td colspan="4" class="topic-label">Topic</td>
            <td *ngFor="let testNum of getVisibleTestNumbers()">
              <input 
                type="text" 
                [(ngModel)]="topics['test' + testNum]" 
                (blur)="onTopicChange()"
                class="topic-input"
                placeholder="Enter topic"
                required>
            </td>
          </tr>
          <!-- Date Row -->
          <tr class="date-row">
            <td colspan="4" class="date-label">Date</td>
            <td *ngFor="let testNum of getVisibleTestNumbers()">
              <input 
                type="date" 
                [(ngModel)]="testDates['test' + testNum]" 
                (change)="onDateChange()"
                (blur)="onDateChange()"
                class="date-input"
                required>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Action buttons (marks auto-save as you enter them) -->
    <div class="action-buttons">
      <span class="auto-save-hint" *ngIf="students.length > 0">Marks, topics, and dates are saved automatically when you leave a field.</span>
      <button 
        class="btn btn-outline" 
        (click)="calculateStatistics()"
        title="View Statistics">
        <span class="btn-icon">ğŸ“ˆ</span>
        <span>Statistics</span>
      </button>
    </div>
  </div>

  <!-- No Subject Selected -->
  <div *ngIf="!loading && selectedClass && !selectedSubject && availableSubjects.length > 0" class="no-data">
    <p>Please select a subject to enter marks.</p>
  </div>

  <!-- No Students Message -->
  <div *ngIf="!loading && selectedClass && selectedSubject && students.length === 0" class="no-data">
    <p>No students enrolled in this class.</p>
  </div>

  <!-- No Class Selected -->
  <div *ngIf="!loading && !selectedClass" class="no-data">
    <p>Please select a class to view the record book.</p>
  </div>
</div>

